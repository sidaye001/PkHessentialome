Original Perturbation analysis for Pk is mainly in 202212novaseq folder
Original Perturbation analysis for Bd is mainly in 202307novaseq folder
The modified and simplified version for Pk is in 2023011Novaseq folder

The perturbation model1/2 by 202230611 is to measures the log2FC within each gene rather than CDS.
The perturbation model1/2 by 202230620 is to measures the log2FC within CDS. DIG matrix has been modified to only sum the reads mapped to TTAA sites within CDS/exon for each genes(edgeR model)

VC model details:
####FC_sites column means new_df_FC$FC_sites <- (Tnseq.c2$average+1)/(Tnseq.c1$average+1)
####log2FC_sites means new_df$Log2FC_sites <- log2(new_df_FC_exon$FC_sites)
####CV_inverse means (mean(log2FC_sites)+1)/(sd(log2FC_sites)+1) because it can separate the dots properly in cv_inverse scatter plot, I have tried log2(mean_FC_sites)+1/log2(sd_FC_sites)+1, dots are clustered closely to each other.
####in cv_inverse model, genes with <3 TTAA within exons are removed, and sites across 2 WTs and treated group with FC_sites=1(which means for raw read counts, WT1=WT2=treated group=0) are removed in order to reduce the effect of variation, 

!!!!! Previously,I label the sites with FC_sites are not 1 as :
new_df_FC_exon <- new_df_FC_exon%>%group_by(GeneID)%>% mutate(num.sites = n()/2)
This will cause the remaining sites (FC_sites!=1)>=6, then, the gene will be remained.
On 20230729, I changed this code into :
new_df_FC_exon <- new_df_FC_exon%>%group_by(GeneID)%>% mutate(num.sites = n())
Which will cause the remaining sites (FC_sites!=1)>=3, then, the gene will be remained. 0912900 know pain will survive on SetA_DHA_High_day4 and SetA_DHA_Low_day4. This step will affect the final gene list survive

Also, I used the left_join(cv_inverse,edgeR) for merging edgeR and cv_inverse model, so cv_inverse model's final gene list will affect the other one. !!!!Only genes are both appear in edgeR and cv_inverse model are remained, genes remained will affect the quantile of the genes 

####Be careful about the temporary files, it will cause the bugs in running the script


#count matrix piped into cv_inverse model has been removed bg noise (each samples' mean of mapped reads within 25 bg genes' genic regions，since this is a bg noise which will be used to remove every site's noise including TTAA sites locating at intergenic and intronic region)

#bg noises are removed for DIG matrix at gene level, which means calculate each samples' 25 bg genes' total mapped reads at genie regions, and remove corresponding bg noise per sample

#The reason why I showed on 20230623 the calculation of log2FC in cv_inverse model looks inconsistent is that the matrix piped in when I showed is a wrong matrix, I piped in cm_Pk_Perturbation_Bg_removed_siteslevel.xlsx, while the right matrix should be the matrix after cpm normalization, -1.730562 for A_mean GNF_High_day15 is generated by cpm matrix cm_Pk_Perturbation_Bg_removed_siteslevel_CPM_normalized.xlsx, and I have double-checked it, it is reproducible

########!!!!Please note that the count matrix pipe in two models should be corresponds to Perturb_Comparison_Info_all table(this table is based on DIG table of which the first column is geneID column, this table has already removed TPNXXX samples which is not included into perturbation analysis, and also DIG table colnames are a little bit different since the first column is geneID and then is the sample names.）

Perturbation_analysis_Pk_countmatrix2DIGmatrix_preparation.R gives the /Users/sidaye/Documents/R/Tnseq/202307_Novaseq/Tnseq202307/Output/Perturbation_CDS/Perturbation_analysis_all/original_tables/Perturbation_sample_list_r123.txt


#####Step1:cm_Location_conversion_for_exon_extraction.R
Convert the location columns of count matrix because of the palindrome structure of TTAA, and we need to use it the extract exons only for genes, this step is both required for edgeR model and CV_inverse model

#####Step2: Perturbation_analysis_Pk_countmatrix2DIGmatrix_preparation to turn cm into DIG.R
Turn original count matrix labelled with exon conversion into DIG and combined with previous runs

#####Step3:Perturbation_analysis_Pk_DIG_bg_removing_genelevel.R
Remove DIG bg based on 25（the first time)/22(the second time) gold list essential genes at gene level


#####Step4: CM_TM_siteslevel_bg_noise_removal_CPM.R
to remove bg noise and CPM normalization in original count matrix and turned into exon converted; 

#####Step5: run Perturbation_analysis_Pk_Log2FC_VC_analysis_siteslevel2.R for cv_inverse model
Pipe in bg noise removed at sites level and CPM nomalized count matrix in Log2FC_VC model

#####Step6: run Perturbation_analysis_Pk_edgeR_batch_processing.R for edgeR model
Pipe in DIG bg noise removed at gene level

#####Step7: run Perturbation_cv_inverse_and_edgeR_setAandsetB_comparison.R for plotting


#####Step8:Perturbation_candidates_filters_final1.R to find the intersection between any timepoints and concentration for one single comparison; Perturbation_cv_inverse_and_edgeR_setAandsetB_comparison_and_candidate_filter2.R; compare setA vs setB edgeR log2FC/setA vs setB log2FC_sites/setA vs setB cv_inverse

#####Note: cv_inverse=(mean(log2(FC_sites))+1)/sd(log2(FC_sites))+1) rather than log2(u/sd), since to take the log first will pull dots together and reduce the effect of sd, and those sites has huge variation will not have a big impact upon the cv_inverse results. !!!!!!

#####Step9: Perturbation_analysis9_drugmegatable_edgeR_VC_merged to merge tables for beta change-trending plot and visualize it 


#Make sure in the edgeR model, the matrix piped into it is CPM normalized matrix: the edgeR has a step to do the cpm
#until 20230629, the matrix piped into edgeR is the DIG_CDS_bg_noise_removed; the matrix piped into cv_inverse is the cm_bg_removal_cpm
#cv_inverse model has been updated multiple time, first we use setA vs setB cv inverse model as the first criteria to filter out candidate genes(97 percentile for cv_inverse value) and then check the rank of max.log2FC.edgeR. Then, we think log2FC.edgeR should be more important, since if the log2FC is not high after 15 days, it would be really hard to observe the phenotype especially for drug perturbation.




1. VC (FC and sd)
2. Set A versus Set B  (bioreps)
3. IGV spot check.  (are there truncations?)
4. Beta change, direction over time.
5. High versus low selection……come up?
6. Pathway analysis (relaxed, based on VC)
